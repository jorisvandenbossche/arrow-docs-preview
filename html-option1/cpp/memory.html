

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Management &#8212; Apache Arrow v3.0.0.dev94+g959e8c558.d20201103</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c78d4f2b1f8277c2fa0830b4506d5cfe.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.8636327e669f6dcffc22.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Arrays" href="arrays.html" />
    <link rel="prev" title="Using Arrow C++ in your own project" href="cmake.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../index.html">
    
      <img src="../_static/arrow.png" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    
    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../spec.html">Specifications and Protocols</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../libraries.html">Libraries</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../developers.html">Development</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
          
            
                <li class="">
                    <a href="../status.html">Implementation Status</a>
                </li>
            
          
            
                <li class="">
                    <a href="https://arrow.apache.org/docs/c_glib/">C/GLib</a>
                </li>
            
          
            
  
                <li class="active">
                    <a href="index.html">C++</a>
                    <ul>
                    
                        <li class="active">
                            <a href="getting_started.html">User Guide</a>
                        </li>
                    
                        <li class="">
                            <a href="examples/index.html">Examples</a>
                        </li>
                    
                        <li class="">
                            <a href="api.html">API Reference</a>
                        </li>
                    
                    </ul>
                </li>
            
          
            
                <li class="">
                    <a href="https://github.com/apache/arrow/blob/master/csharp/README.md">C#</a>
                </li>
            
          
            
                <li class="">
                    <a href="https://godoc.org/github.com/apache/arrow/go/arrow">Go</a>
                </li>
            
          
            
                <li class="">
                    <a href="../java/index.html">Java</a>
                </li>
            
          
            
                <li class="">
                    <a href="https://arrow.apache.org/docs/js/">JavaScript</a>
                </li>
            
          
            
                <li class="">
                    <a href="https://github.com/apache/arrow/blob/master/matlab/README.md">MATLAB</a>
                </li>
            
          
            
                <li class="">
                    <a href="../python/index.html">Python</a>
                </li>
            
          
            
                <li class="">
                    <a href="https://arrow.apache.org/docs/r/">R</a>
                </li>
            
          
            
                <li class="">
                    <a href="https://github.com/apache/arrow/blob/master/ruby/README.md">Ruby</a>
                </li>
            
          
            
                <li class="">
                    <a href="https://docs.rs/crate/arrow/">Rust</a>
                </li>
            
          
        
        
        
        
      </ul>
  
  </nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#buffers" class="nav-link">Buffers</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#accessing-buffer-memory" class="nav-link">Accessing Buffer Memory</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#slicing" class="nav-link">Slicing</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#allocating-a-buffer" class="nav-link">Allocating a Buffer</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#building-a-buffer" class="nav-link">Building a Buffer</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#memory-pools" class="nav-link">Memory Pools</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#default-memory-pool" class="nav-link">Default Memory Pool</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#stl-integration" class="nav-link">STL Integration</a>
        </li>
    
            </ul>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#devices" class="nav-link">Devices</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#device-agnostic-programming" class="nav-link">Device-Agnostic Programming</a>
        </li>
    
            </ul>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="memory-management">
<h1>Memory Management<a class="headerlink" href="#memory-management" title="Permalink to this headline">¶</a></h1>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="api/memory.html"><span class="doc">Memory management API reference</span></a></p>
</div>
<div class="section" id="buffers">
<h2>Buffers<a class="headerlink" href="#buffers" title="Permalink to this headline">¶</a></h2>
<p>To avoid passing around raw data pointers with varying and non-obvious
lifetime rules, Arrow provides a generic abstraction called <a class="reference internal" href="api/memory.html#_CPPv4N5arrow6BufferE" title="arrow::Buffer"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::Buffer</span></code></a>.
A Buffer encapsulates a pointer and data size, and generally also ties its
lifetime to that of an underlying provider (in other words, a Buffer should
<em>always</em> point to valid memory till its destruction).  Buffers are untyped:
they simply denote a physical memory area regardless of its intended meaning
or interpretation.</p>
<p>Buffers may be allocated by Arrow itself , or by third-party routines.
For example, it is possible to pass the data of a Python bytestring as a Arrow
buffer, keeping the Python object alive as necessary.</p>
<p>In addition, buffers come in various flavours: mutable or not, resizable or
not.  Generally, you will hold a mutable buffer when building up a piece
of data, then it will be frozen as an immutable container such as an
<a class="reference internal" href="arrays.html"><span class="doc">array</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some buffers may point to non-CPU memory, such as GPU-backed memory
provided by a CUDA context.  If you’re writing a GPU-aware application,
you will need to be careful not to interpret a GPU memory pointer as
a CPU-reachable pointer, or vice-versa.</p>
</div>
<div class="section" id="accessing-buffer-memory">
<h3>Accessing Buffer Memory<a class="headerlink" href="#accessing-buffer-memory" title="Permalink to this headline">¶</a></h3>
<p>Buffers provide fast access to the underlying memory using the
<a class="reference internal" href="api/memory.html#_CPPv4NK5arrow6Buffer4sizeEv" title="arrow::Buffer::size"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">size()</span></code></a> and <a class="reference internal" href="api/memory.html#_CPPv4NK5arrow6Buffer4dataEv" title="arrow::Buffer::data"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">data()</span></code></a> accessors
(or <a class="reference internal" href="api/memory.html#_CPPv4N5arrow6Buffer12mutable_dataEv" title="arrow::Buffer::mutable_data"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">mutable_data()</span></code></a> for writable access to a mutable
buffer).</p>
</div>
<div class="section" id="slicing">
<h3>Slicing<a class="headerlink" href="#slicing" title="Permalink to this headline">¶</a></h3>
<p>It is possible to make zero-copy slices of buffers, to obtain a buffer
referring to some contiguous subset of the underlying data.  This is done
by calling the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::SliceBuffer()</span></code> and <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::SliceMutableBuffer()</span></code>
functions.</p>
</div>
<div class="section" id="allocating-a-buffer">
<h3>Allocating a Buffer<a class="headerlink" href="#allocating-a-buffer" title="Permalink to this headline">¶</a></h3>
<p>You can allocate a buffer yourself by calling one of the
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::AllocateBuffer()</span></code> or <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::AllocateResizableBuffer()</span></code>
overloads:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">arrow</span><span class="o">::</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">&gt;&gt;</span> <span class="n">maybe_buffer</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">::</span><span class="n">AllocateBuffer</span><span class="p">(</span><span class="mi">4096</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">maybe_buffer</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
   <span class="c1">// ... handle allocation error</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">arrow</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">*</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">maybe_buffer</span><span class="p">);</span>
<span class="kt">uint8_t</span><span class="o">*</span> <span class="n">buffer_data</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">mutable_data</span><span class="p">();</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer_data</span><span class="p">,</span> <span class="s">&quot;hello world&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
</pre></div>
</div>
<p>Allocating a buffer this way ensures it is 64-bytes aligned and padded
as recommended by the <a class="reference internal" href="../format/Layout.html"><span class="doc">Arrow memory specification</span></a>.</p>
</div>
<div class="section" id="building-a-buffer">
<h3>Building a Buffer<a class="headerlink" href="#building-a-buffer" title="Permalink to this headline">¶</a></h3>
<p>You can also allocate <em>and</em> build a Buffer incrementally, using the
<a class="reference internal" href="api/memory.html#_CPPv4N5arrow13BufferBuilderE" title="arrow::BufferBuilder"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::BufferBuilder</span></code></a> API:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">BufferBuilder</span> <span class="n">builder</span><span class="p">;</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;hello &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="n">builder</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">arrow</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">builder</span><span class="p">.</span><span class="n">Finish</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">).</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
   <span class="c1">// ... handle buffer allocation error</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="memory-pools">
<h2>Memory Pools<a class="headerlink" href="#memory-pools" title="Permalink to this headline">¶</a></h2>
<p>When allocating a Buffer using the Arrow C++ API, the buffer’s underlying
memory is allocated by a <a class="reference internal" href="api/memory.html#_CPPv4N5arrow10MemoryPoolE" title="arrow::MemoryPool"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::MemoryPool</span></code></a> instance.  Usually this
will be the process-wide <em>default memory pool</em>, but many Arrow APIs allow
you to pass another MemoryPool instance for their internal allocations.</p>
<p>Memory pools are used for large long-lived data such as array buffers.
Other data, such as small C++ objects and temporary workspaces, usually
goes through the regular C++ allocators.</p>
<div class="section" id="default-memory-pool">
<h3>Default Memory Pool<a class="headerlink" href="#default-memory-pool" title="Permalink to this headline">¶</a></h3>
<p>Depending on how Arrow was compiled, the default memory pool may use the
standard C <code class="docutils literal notranslate"><span class="pre">malloc</span></code> allocator, or a <a class="reference external" href="http://jemalloc.net/">jemalloc</a> heap.</p>
</div>
<div class="section" id="stl-integration">
<h3>STL Integration<a class="headerlink" href="#stl-integration" title="Permalink to this headline">¶</a></h3>
<p>If you wish to use a Arrow memory pool to allocate the data of STL containers,
you can do so using the <a class="reference internal" href="api/memory.html#_CPPv4I0EN5arrow3stl9allocatorE" title="arrow::stl::allocator"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::stl::allocator</span></code></a> wrapper.</p>
<p>Conversely, you can also use a STL allocator to allocate Arrow memory,
using the <a class="reference internal" href="api/memory.html#_CPPv4I0EN5arrow3stl13STLMemoryPoolE" title="arrow::stl::STLMemoryPool"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::stl::STLMemoryPool</span></code></a> class.  However, this may be less
performant, as STL allocators don’t provide a resizing operation.</p>
</div>
</div>
<div class="section" id="devices">
<h2>Devices<a class="headerlink" href="#devices" title="Permalink to this headline">¶</a></h2>
<p>Many Arrow applications only access host (CPU) memory.  However, in some cases
it is desirable to handle on-device memory (such as on-board memory on a GPU)
as well as host memory.</p>
<p>Arrow represents the CPU and other devices using the
<a class="reference internal" href="api/memory.html#_CPPv4N5arrow6DeviceE" title="arrow::Device"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::Device</span></code></a> abstraction.  The associated class <a class="reference internal" href="api/memory.html#_CPPv4N5arrow13MemoryManagerE" title="arrow::MemoryManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::MemoryManager</span></code></a>
specifies how to allocate on a given device.  Each device has a default memory manager, but
additional instances may be constructed (for example, wrapping a custom
<a class="reference internal" href="api/memory.html#_CPPv4N5arrow10MemoryPoolE" title="arrow::MemoryPool"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::MemoryPool</span></code></a> the CPU).
<a class="reference internal" href="api/memory.html#_CPPv4N5arrow13MemoryManagerE" title="arrow::MemoryManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::MemoryManager</span></code></a> instances which specify how to allocate
memory on a given device (for example, using a particular
<a class="reference internal" href="api/memory.html#_CPPv4N5arrow10MemoryPoolE" title="arrow::MemoryPool"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">arrow::MemoryPool</span></code></a> on the CPU).</p>
<div class="section" id="device-agnostic-programming">
<h3>Device-Agnostic Programming<a class="headerlink" href="#device-agnostic-programming" title="Permalink to this headline">¶</a></h3>
<p>If you receive a Buffer from third-party code, you can query whether it is
CPU-readable by calling its <a class="reference internal" href="api/memory.html#_CPPv4NK5arrow6Buffer6is_cpuEv" title="arrow::Buffer::is_cpu"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">is_cpu()</span></code></a> method.</p>
<p>You can also view the Buffer on a given device, in a generic way, by calling
<a class="reference internal" href="api/memory.html#_CPPv4N5arrow6Buffer4ViewENSt10shared_ptrI6BufferEERKNSt10shared_ptrI13MemoryManagerEE" title="arrow::Buffer::View"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::Buffer::View()</span></code></a> or <a class="reference internal" href="api/memory.html#_CPPv4N5arrow6Buffer10ViewOrCopyENSt10shared_ptrI6BufferEERKNSt10shared_ptrI13MemoryManagerEE" title="arrow::Buffer::ViewOrCopy"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::Buffer::ViewOrCopy()</span></code></a>.  This will
be a no-operation if the source and destination devices are identical.
Otherwise, a device-dependent mechanism will attempt to construct a memory
address for the destination device that gives access to the buffer contents.
Actual device-to-device transfer may happen lazily, when reading the buffer
contents.</p>
<p>Similarly, if you want to do I/O on a buffer without assuming a CPU-readable
buffer, you can call <a class="reference internal" href="api/memory.html#_CPPv4N5arrow6Buffer9GetReaderENSt10shared_ptrI6BufferEE" title="arrow::Buffer::GetReader"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::Buffer::GetReader()</span></code></a> and
<a class="reference internal" href="api/memory.html#_CPPv4N5arrow6Buffer9GetWriterENSt10shared_ptrI6BufferEE" title="arrow::Buffer::GetWriter"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">arrow::Buffer::GetWriter()</span></code></a>.</p>
<p>For example, to get an on-CPU view or copy of an arbitrary buffer, you can
simply do:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">arrow</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">arbitrary_buffer</span> <span class="o">=</span> <span class="p">...</span> <span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">arrow</span><span class="o">::</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">cpu_buffer</span> <span class="o">=</span> <span class="n">arrow</span><span class="o">::</span><span class="n">Buffer</span><span class="o">::</span><span class="n">ViewOrCopy</span><span class="p">(</span>
   <span class="n">arbitrary_buffer</span><span class="p">,</span> <span class="n">arrow</span><span class="o">::</span><span class="n">default_cpu_memory_manager</span><span class="p">());</span>
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="cmake.html" title="previous page">Using Arrow C++ in your own project</a>
    <a class='right-next' id="next-link" href="arrays.html" title="next page">Arrays</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../_static/js/index.8636327e669f6dcffc22.js"></script>


    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-107500873-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107500873-1');
</script>

  </body>
</html>